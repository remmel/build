(()=>{"use strict";let e=new function(e){let t=this;this.errorOutput=document.getElementById("errorMessage");const n="experiments/ip/opencv-4.4.0.js";function i(){t.onCameraStartedCallback&&t.onCameraStartedCallback(t.stream,t.video)}this.loadOpenCv=function(e){let i=document.createElement("script");i.setAttribute("async",""),i.setAttribute("type","text/javascript"),i.addEventListener("load",(async()=>{cv.getBuildInformation?(console.log(cv.getBuildInformation()),e()):cv instanceof Promise?(cv=await cv,console.log(cv.getBuildInformation()),e()):cv.onRuntimeInitialized=()=>{console.log(cv.getBuildInformation()),e()}})),i.addEventListener("error",(()=>{t.printError("Failed to load "+n)})),i.src=n;let a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(i,a)},this.createFileFromUrl=function(e,n,i){let a=new XMLHttpRequest;a.open("GET",n,!0),a.responseType="arraybuffer",a.onload=function(r){if(4===a.readyState)if(200===a.status){let t=new Uint8Array(a.response);cv.FS_createDataFile("/",e,t,!0,!1,!1),i()}else t.printError("Failed to load "+n+" status: "+a.status)},a.send()},this.loadImageToCanvas=function(e,t){let n=document.getElementById(t),i=n.getContext("2d"),a=new Image;a.crossOrigin="anonymous",a.onload=function(){n.width=a.width,n.height=a.height,i.drawImage(a,0,0,a.width,a.height)},a.src=e},this.clearError=function(){this.errorOutput.innerHTML=""},this.printError=function(e){if(void 0===e)e="";else if("number"==typeof e)isNaN(e)||"undefined"!=typeof cv&&(e="Exception: "+cv.exceptionFromPtr(e).msg);else if("string"==typeof e){let t=Number(e.split(" ")[0]);isNaN(t)||"undefined"!=typeof cv&&(e="Exception: "+cv.exceptionFromPtr(t).msg)}else e instanceof Error&&(e=e.stack.replace(/\n/g,"<br>"));this.errorOutput.innerHTML=e},this.loadCode=function(e,t){let n=document.getElementById(e),i=document.getElementById(t);if("text/code-snippet"!==n.type)throw Error("Unknown code snippet type");i.value=n.text.replace(/^\n/,"")},this.addFileInputHandler=function(e,n){document.getElementById(e).addEventListener("change",(e=>{let i=e.target.files;if(i.length>0){let e=URL.createObjectURL(i[0]);t.loadImageToCanvas(e,n)}}),!1)},this.startCamera=function(e,n,a){let r=document.getElementById(a);r||(r=document.createElement("video"));let o={qvga:{width:{exact:320},height:{exact:240}},vga:{width:{exact:640},height:{exact:480}}}[e];o||(o=!0),navigator.mediaDevices.getUserMedia({video:o,audio:!1}).then((function(e){r.srcObject=e,r.play(),t.video=r,t.stream=e,t.onCameraStartedCallback=n,r.addEventListener("canplay",i,!1)})).catch((function(e){t.printError("Camera Error: "+e.name+" "+e.message)}))},this.stopCamera=function(){this.video&&(this.video.pause(),this.video.srcObject=null,this.video.removeEventListener("canplay",i)),this.stream&&this.stream.getVideoTracks()[0].stop()}}("errorMessage"),t=!1,n=document.getElementById("videoInput"),i=document.getElementById("startAndStop"),a=document.getElementById("canvasOutput"),r=a.getContext("2d");function o(){t=!0,i.innerText="Stop",n.width=n.videoWidth,n.height=n.videoHeight,function(){let n=document.getElementById("videoInput"),i=new cv.Mat(n.height,n.width,cv.CV_8UC4),a=new cv.Mat(n.height,n.width,cv.CV_8UC4),r=new cv.Mat,o=new cv.VideoCapture(n),c=new cv.RectVector,d=new cv.CascadeClassifier;d.load("haarcascade_frontalface_default.xml");setTimeout((function n(){try{if(!t)return i.delete(),a.delete(),r.delete(),c.delete(),void d.delete();let e=Date.now();o.read(i),i.copyTo(a),cv.cvtColor(a,r,cv.COLOR_RGBA2GRAY,0),d.detectMultiScale(r,c,1.1,3,0);for(let e=0;e<c.size();++e){let t=c.get(e),n=new cv.Point(t.x,t.y),i=new cv.Point(t.x+t.width,t.y+t.height);cv.rectangle(a,n,i,[255,0,0,255])}cv.imshow("canvasOutput",a);let s=1e3/30-(Date.now()-e);setTimeout(n,s)}catch(t){e.printError(t)}}),0)}()}i.addEventListener("click",(()=>{t?(e.stopCamera(),t=!1,r.clearRect(0,0,a.width,a.height),i.innerText="Start"):(e.clearError(),e.startCamera("qvga",o,"videoInput"))})),e.loadOpenCv((()=>{let t="haarcascade_frontalface_default.xml";e.createFileFromUrl(t,"experiments/ip/"+t,(()=>{i.removeAttribute("disabled")}))}))})();